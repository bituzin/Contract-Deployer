import{ar as j,as as T,at as P,au as J,av as C,aw as M,ax as A,ay as W}from"./index-6e4b0420.js";const q=new Map;async function D(c){const{getSocket:i,keepAlive:f=!0,key:h="socket",reconnect:y=!0,url:p}=c,{interval:_=3e4}=typeof f=="object"?f:{},{attempts:L=5,delay:b=2e3}=typeof y=="object"?y:{},e=JSON.stringify({keepAlive:f,key:h,url:p,reconnect:y});let a=q.get(e);if(a)return a;let S=0;const{schedule:E}=j({id:e,fn:async()=>{const g=new Map,d=new Map;let w,v,k,O=!1;function R(){if(y&&S<L){if(O)return;O=!0,S++,v==null||v.close(),setTimeout(async()=>{await I().catch(console.error),O=!1},b)}else g.clear(),d.clear()}async function I(){const u=await i({onClose(){var t,o;for(const n of g.values())(t=n.onError)==null||t.call(n,new C({url:p}));for(const n of d.values())(o=n.onError)==null||o.call(n,new C({url:p}));R()},onError(t){var o,n;w=t;for(const s of g.values())(o=s.onError)==null||o.call(s,w);for(const s of d.values())(n=s.onError)==null||n.call(s,w);R()},onOpen(){w=void 0,S=0},onResponse(t){const o=t.method==="eth_subscription",n=o?t.params.subscription:t.id,s=o?d:g,l=s.get(n);l&&l.onResponse(t),o||s.delete(n)}});if(v=u,f&&(k&&clearInterval(k),k=setInterval(()=>{var t;return(t=v.ping)==null?void 0:t.call(v)},_)),y&&d.size>0){const t=d.entries();for(const[o,{onResponse:n,body:s,onError:l}]of t)s&&(d.delete(o),a==null||a.request({body:s,onResponse:n,onError:l}))}return u}return await I(),w=void 0,a={close(){k&&clearInterval(k),v.close(),q.delete(e)},get socket(){return v},request({body:u,onError:t,onResponse:o}){w&&t&&t(w);const n=u.id??T.take(),s=l=>{var N;typeof l.id=="number"&&n!==l.id||(u.method==="eth_subscribe"&&typeof l.result=="string"&&d.set(l.result,{onResponse:s,onError:t,body:u}),u.method==="eth_unsubscribe"&&d.delete((N=u.params)==null?void 0:N[0]),o(l))};g.set(n,{onResponse:s,onError:t});try{v.request({body:{jsonrpc:"2.0",id:n,...u}})}catch(l){t==null||t(l)}},requestAsync({body:u,timeout:t=1e4}){return P(()=>new Promise((o,n)=>this.request({body:u,onError:n,onResponse:o})),{errorInstance:new J({body:u,url:p}),timeout:t})},requests:g,subscriptions:d,url:p},q.set(e,a),[a]}}),[r,[m]]=await E();return m}async function G(c,i={}){const{keepAlive:f,reconnect:h}=i;return D({async getSocket({onClose:y,onError:p,onOpen:_,onResponse:L}){const b=await M(()=>import("./native-fae38879.js"),[]).then(r=>r.WebSocket),e=new b(c);function a(){e.removeEventListener("close",a),e.removeEventListener("message",S),e.removeEventListener("error",p),e.removeEventListener("open",_),y()}function S({data:r}){if(!(typeof r=="string"&&r.trim().length===0))try{const m=JSON.parse(r);L(m)}catch(m){p(m)}}e.addEventListener("close",a),e.addEventListener("message",S),e.addEventListener("error",p),e.addEventListener("open",_),e.readyState===b.CONNECTING&&await new Promise((r,m)=>{e&&(e.onopen=r,e.onerror=m)});const{close:E}=e;return Object.assign(e,{close(){E.bind(e)(),a()},ping(){try{if(e.readyState===e.CLOSED||e.readyState===e.CLOSING)throw new A({url:e.url,cause:new C({url:e.url})});const r={jsonrpc:"2.0",id:null,method:"net_version",params:[]};e.send(JSON.stringify(r))}catch(r){p(r)}},request({body:r}){if(e.readyState===e.CLOSED||e.readyState===e.CLOSING)throw new A({body:r,url:e.url,cause:new C({url:e.url})});return e.send(JSON.stringify(r))}})},keepAlive:f,reconnect:h,url:c})}function x(c,{body:i,onError:f,onResponse:h}){return c.request({body:i,onError:f,onResponse:h}),c}async function z(c,{body:i,timeout:f=1e4}){return c.requestAsync({body:i,timeout:f})}async function H(c){const i=await G(c);return Object.assign(i.socket,{requests:i.requests,subscriptions:i.subscriptions})}const V={http(c,i){return W(c).request(i)},webSocket:x,webSocketAsync:z};export{G as a,H as g,V as r};
